 <!DOCTYPE html>  <html> <head>   <title>StateMachine.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="hashtables/OrderedList.html">                 <span class="base_path">hashtables/</span><span class="file_name">OrderedList.coffee</span>               </a>                                           <a class="source" href="hashtables/OrderedUniqueList.html">                 <span class="base_path">hashtables/</span><span class="file_name">OrderedUniqueList.coffee</span>               </a>                                           <a class="source" href="hashtables/ChainedHashTable.html">                 <span class="base_path">hashtables/</span><span class="file_name">ChainedHashTable.coffee</span>               </a>                                           <a class="source" href="hashtables/UnorderedList.html">                 <span class="base_path">hashtables/</span><span class="file_name">UnorderedList.coffee</span>               </a>                                           <a class="source" href="hashtables/Element.html">                 <span class="base_path">hashtables/</span><span class="file_name">Element.coffee</span>               </a>                                           <a class="source" href="loadcss.html">                 <span class="base_path"></span><span class="file_name">loadcss.coffee</span>               </a>                                           <a class="source" href="EventLogger.html">                 <span class="base_path"></span><span class="file_name">EventLogger.coffee</span>               </a>                                           <a class="source" href="widgets/ChainedHashTable.html">                 <span class="base_path">widgets/</span><span class="file_name">ChainedHashTable.coffee</span>               </a>                                           <a class="source" href="widgets/raphael.setfixes.html">                 <span class="base_path">widgets/</span><span class="file_name">raphael.setfixes.coffee</span>               </a>                                           <a class="source" href="widgets/RecText.html">                 <span class="base_path">widgets/</span><span class="file_name">RecText.coffee</span>               </a>                                           <a class="source" href="widgets/raphael.class.html">                 <span class="base_path">widgets/</span><span class="file_name">raphael.class.coffee</span>               </a>                                           <a class="source" href="widgets/LinkedList.html">                 <span class="base_path">widgets/</span><span class="file_name">LinkedList.coffee</span>               </a>                                           <a class="source" href="widgets/raphael.line.html">                 <span class="base_path">widgets/</span><span class="file_name">raphael.line.coffee</span>               </a>                                           <a class="source" href="StateMachine.html">                 <span class="base_path"></span><span class="file_name">StateMachine.coffee</span>               </a>                                           <a class="source" href="HashTables.html">                 <span class="base_path"></span><span class="file_name">HashTables.coffee</span>               </a>                                           <a class="source" href="modules/ChainedHashTable.html">                 <span class="base_path">modules/</span><span class="file_name">ChainedHashTable.coffee</span>               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               StateMachine.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><em>A specialized finite state machine used for representing algorithms / data structures</em></p>

<p>A state is defined as a point where we want to stop and give explanations on what's happening.
The state machine signals this as a <a href="http://api.jquery.com/trigger/">custom jQuery event</a>.
Execution state ("variables" of the algorithm, for example) are stored in  <code>@_data</code>; a deep
copy of this is passed as the <code>data</code> attribute of the jQuery event. States that are not <code>ready</code> and
are not an entry point can be considered <strong>breakpoints</strong> with regard to the modeled algorithm.</p>

<h3>A StateMachine works as follows:</h3>

<ul>
<li><strong>Starts</strong> in the special <code>"ready"</code> state</li>
<li>An <strong>entry method</strong> gets called (eg. <code>hashTable.add(key, value)</code>, where <code>add</code> is the entry method).
<code>step(state)</code> is called.</li>
<li>Waits for a <strong>step</strong> or a <strong>run</strong> call (step runs until the next state is reached; run until the <code>ready</code> state is reached).</li>
</ul>

<h3>Properties:</h3>

<ul>
<li><code>_state</code>: The current state name</li>
<li><code>_data</code>: This is used to store data that persist between states</li>
<li><code>_opts</code>: The constructor parameter</li>
</ul>

<p>See <a href="HashTables/ChainedHashTable.html"><code>HashTables/ChainedHashTable.coffe</code></a> for an example StateMachine.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>StateMachine implementation</h2>

<p>The constructor takes a single object parameter with the following fields:</p>

<ul>
<li><code>entryPoints</code>: an array of strings; the name of entry calls</li>
<li><code>transitions</code>; an array of objects like <code>{from: ['ready'], to: ['s1', 's2']}</code>
where <code>s1</code> and <code>s2</code> are states that are valid transitions from the <code>ready</code> state</li>
<li><code>guards</code>: an object like <code>{ready: {s2: -&gt; @_data['number'] == 5}, ...}</code>. This means that
we can transition from state <code>s1</code> to <code>s2</code> only if <code>@_data['number']</code> is <code>5</code>.</li>
<li>Methods with the name of a state will be run on the StateMachine when it transitions
into the state with the same name (before the event is fired).</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s1">&#39;vendor/jquery&#39;</span><span class="p">,</span> <span class="s1">&#39;vendor/underscore&#39;</span><span class="p">],</span> <span class="nf">($, _) -&gt;</span>
  <span class="k">class</span> <span class="nx">StateMachine</span>
    <span class="nv">constructor: </span><span class="nf">(opts) -&gt;</span>
      <span class="vi">@_state = </span><span class="s1">&#39;ready&#39;</span>
      <span class="vi">@_data = </span><span class="p">{}</span>
      <span class="vi">@_opts = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span><span class="nv">entryPoints: </span><span class="p">[],</span> <span class="nv">transitions: </span><span class="p">[],</span> <span class="nv">guards: </span><span class="p">{}},</span> <span class="nx">opts</span><span class="p">)</span>

      <span class="nx">@_opts</span><span class="p">.</span><span class="nx">transitions</span><span class="p">.</span><span class="nx">unshift</span> <span class="p">{</span><span class="nv">from: </span><span class="p">[</span><span class="s1">&#39;ready&#39;</span><span class="p">],</span> <span class="nv">to: </span><span class="nx">@_opts</span><span class="p">.</span><span class="nx">entryPoints</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Create entry methods. They set the <code>@_data.params</code> property to the arguments they got, then start the machine.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">name</span> <span class="k">in</span> <span class="nx">@_opts</span><span class="p">.</span><span class="nx">entryPoints</span>
        <span class="nx">do</span> <span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="k">this</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(params...) -&gt;</span>
            <span class="k">if</span> <span class="nx">@_state</span> <span class="o">!=</span> <span class="s1">&#39;ready&#39;</span>
              <span class="k">throw</span> <span class="s1">&#39;Entry call can only be made when in \&#39;ready\&#39; state&#39;</span>
            <span class="vi">@_data.params = </span><span class="nx">params</span>
            <span class="nx">@step</span> <span class="p">{</span><span class="nv">stepRequest: </span><span class="nx">name</span><span class="p">}</span>
            <span class="k">return</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Can we go from where we are to the <code>to</code> state, based on the guards we have?</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_guardCheck: </span><span class="nf">(to) -&gt;</span>
      <span class="k">if</span> <span class="nx">@_opts</span><span class="p">.</span><span class="nx">guards</span> <span class="o">and</span> <span class="nx">@_opts</span><span class="p">.</span><span class="nx">guards</span><span class="p">[</span><span class="nx">@_state</span><span class="p">]</span> <span class="o">and</span> <span class="nx">@_opts</span><span class="p">.</span><span class="nx">guards</span><span class="p">[</span><span class="nx">@_state</span><span class="p">][</span><span class="nx">to</span><span class="p">]</span>
        <span class="nx">@_opts</span><span class="p">.</span><span class="nx">guards</span><span class="p">[</span><span class="nx">@_state</span><span class="p">][</span><span class="nx">to</span><span class="p">].</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p><strong>trigger</strong>: Convinience method to fire a jQuery event</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">trigger: </span><span class="nf">(eventType, data=@_data) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">trigger</span> <span class="nx">eventType</span><span class="p">,</span> <span class="p">[</span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">data</span><span class="p">)]</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p><strong>step</strong>: Try to take a step in the algorithm.</p>

<p>The <code>to</code> parameter is optional; only entry points pass it in. In any other event we need to be able
to determine where to go from where we are.</p>

<p>Candidates for the next state are defined by <code>@_opts.transitions</code> and the current state.
These are then filtered with <code>@_opts.guards</code>, using <code>@_data</code>.</p>

<p>If the next state could be determined, then the appropriate part of the modeled algorithm is run (<code>@_opts[state]</code>),
if such a method exists. The result of this is assigned to <code>@_data.result</code>. Finally an event is fired to notify
the rest of the application about what happened.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">step: </span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="nv">to = </span><span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">to</span><span class="p">)</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isUndefined</span><span class="p">(</span><span class="nx">to</span><span class="p">.</span><span class="nx">stepRequest</span><span class="p">)</span> <span class="k">then</span> <span class="kc">null</span> <span class="k">else</span> <span class="nx">to</span><span class="p">.</span><span class="nx">stepRequest</span>
      <span class="nv">candidates = </span><span class="nx">_</span><span class="p">.</span><span class="nx">flatten</span> <span class="p">(</span><span class="nx">transition</span><span class="p">.</span><span class="nx">to</span> <span class="k">for</span> <span class="nx">transition</span> <span class="k">in</span> <span class="nx">@_opts</span><span class="p">.</span><span class="nx">transitions</span> <span class="k">when</span> <span class="nx">@_state</span> <span class="k">in</span> <span class="nx">transition</span><span class="p">.</span><span class="nx">from</span><span class="p">)</span>
      <span class="nv">candidates = </span><span class="p">(</span><span class="nx">c</span> <span class="k">for</span> <span class="nx">c</span> <span class="k">in</span> <span class="nx">candidates</span> <span class="k">when</span> <span class="nx">@_guardCheck</span><span class="p">(</span><span class="nx">c</span><span class="p">))</span>
      <span class="k">if</span> <span class="nx">candidates</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">and</span> <span class="nx">to</span> <span class="o">not</span> <span class="k">in</span> <span class="nx">candidates</span>
          <span class="k">throw</span> <span class="s2">&quot;Couldn&#39;t transition into requested state&quot;</span>
        <span class="k">else</span>
          <span class="vi">@_state = </span><span class="nx">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">candidates</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="nx">to</span> <span class="o">!=</span> <span class="kc">null</span>
          <span class="k">if</span> <span class="nx">to</span> <span class="k">in</span> <span class="nx">candidates</span>
            <span class="vi">@_state = </span><span class="nx">to</span>
          <span class="k">else</span>
            <span class="k">throw</span> <span class="s2">&quot;Couldn&#39;t transition into requested state #{to}. Candidates were #{candidates}&quot;</span>
        <span class="k">else</span>
          <span class="k">throw</span> <span class="s2">&quot;Couldn&#39;t figure out where to go from #{@_state}. Candidates were #{candidates}&quot;</span>
      <span class="vi">@_data.result = </span><span class="nx">@_opts</span><span class="p">[</span><span class="nx">@_state</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">@_data</span><span class="p">.</span><span class="nx">params</span><span class="p">)</span>
      <span class="nx">@trigger</span> <span class="nx">@_state</span>
      <span class="k">return</span> <span class="k">this</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Keep <code>step</code>ping until until the <code>ready</code> state is reached; return the result of the last algorithm-part.
Use this if you want to run the algorithm without the breakpoints.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">run: </span><span class="o">-&gt;</span>
      <span class="nv">ret = </span><span class="kc">null</span>
      <span class="k">while</span> <span class="nx">@_state</span> <span class="o">!=</span> <span class="s1">&#39;ready&#39;</span>
        <span class="nv">ret = </span><span class="nx">@_data</span><span class="p">.</span><span class="nx">result</span>
        <span class="nx">@step</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">ret</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Convenience method for binding to events fired on state changes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">bind: </span><span class="nf">(type, handler) -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="k">this</span><span class="p">).</span><span class="nx">bind</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">handler</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html>  